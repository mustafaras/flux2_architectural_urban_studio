# FLUX.2 RabbitMQ Configuration
# Location: /opt/flux2/config/rabbitmq/rabbitmq.conf

# ============================================================
# NETWORK AND PROTOCOL
# ============================================================

listeners.tcp.default = 5672
listeners.ssl.default = 5671

# Management plugin on port 15672
management.tcp.port = 15672

# ============================================================
# RABBIT NODE SETTINGS
# ============================================================

nodename = flux2@localhost

# Disk space threshold (50MB minimum free)
disk_free_limit.absolute = 50MB

# Memory watermark
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.75

# ============================================================
# MESSAGE PERSISTENCE
# ============================================================

queue_master_locator = min-masters

# ============================================================
# PERFORMANCE TUNING
# ============================================================

# Channel parameters
channel_max = 2048
connection_max = infinity

# Message queue settings
total_memory_available_override_value = 4GB

# Consumer prefetch (QoS)
# Each consumer prefetches max 10 unacked messages
consumer_max_prefetch = 10

# ============================================================
# DEFAULT VHOST AND USER
# ============================================================

# Default vhost
default_vhost = /

# ============================================================
# FLUX.2 EXCHANGES AND QUEUES
# ============================================================

# Queue Configuration
# 
# Exchange: flux2.tasks
#   Type: topic
#   Durable: yes
#   Auto-delete: no
#
# Queues:
#   - flux2.generation.requests
#   - flux2.generation.results
#   - flux2.model.requests
#   - flux2.cache.invalidate
#
# Bindings:
#   - flux2.generation.requests ← flux2.tasks (routing: generation.*)
#   - flux2.model.requests ← flux2.tasks (routing: model.*)

# ============================================================
# CLUSTERING (Optional - for HA)
# ============================================================

# cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
# cluster_formation.classic_config.nodes.1 = rabbit@worker1
# cluster_formation.classic_config.nodes.2 = rabbit@worker2
# cluster_formation.classic_config.nodes.3 = rabbit@worker3

# ============================================================
# MANAGEMENT PLUGIN
# ============================================================

management.load_definitions = /opt/flux2/config/rabbitmq/definitions.json

# ============================================================
# LOGGING
# ============================================================

log.console = true
log.console.level = info
log.console.metadata_format = json
log.file.level = info

# ============================================================
# SECURITY
# ============================================================

# SSL Configuration (optional)
# listeners.ssl.default = 5671
# ssl_options.cacertfile = /path/to/ca_certificate.pem
# ssl_options.certfile   = /path/to/server_certificate.pem
# ssl_options.keyfile    = /path/to/server_key.pem
# ssl_options.password   = secure_password
# ssl_options.verify     = verify_peer
# ssl_options.fail_if_no_peer_cert = false

# ============================================================
# MANAGEMENT CREDENTIALS
# ============================================================

# Create users via management plugin:
# rabbitmqctl add_user flux2_app secure_password
# rabbitmqctl set_permissions -p / flux2_app "^flux2\." "^flux2\." "^flux2\."

# ============================================================
# PLUGINS
# ============================================================

management.enable_queue_totals = true
rabbitmq_management_agent.disable_metrics_collector = false

# ============================================================
# NOTES
# ============================================================
#
# Installation:
#   apt-get install rabbitmq-server (Linux)
#   brew install rabbitmq (macOS)
#
# Start RabbitMQ:
#   rabbitmq-server
#   systemctl start rabbitmq-server (Linux)
#
# Management UI:
#   http://127.0.0.1:15672 (default: guest/guest)
#
# Create Queue:
#   rabbitmqctl declare_queue name=flux2.generation.requests
#
# Create Exchange:
#   rabbitmqctl declare_exchange name=flux2.tasks type=topic
#
# List Users:
#   rabbitmqctl list_users
#
# Monitor:
#   rabbitmqctl status
#   rabbitmqctl list_queues name messages consumers
#
